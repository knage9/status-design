document.addEventListener("DOMContentLoaded",function(){const d=document.getElementById("popupOverlay"),T=document.getElementById("popupClose"),v=document.getElementById("continueBtn"),u=document.getElementById("submitBtn"),_=document.getElementById("successBtn"),s=document.getElementById("userName"),r=document.getElementById("userPhone"),m=document.getElementById("carModel"),B=document.querySelectorAll(".popup__step"),N=document.getElementById("popupTitle"),g=document.querySelectorAll(".popup__service-btn"),C=document.querySelectorAll(".popup__additional-btn"),L=document.getElementById("nameError"),l=document.getElementById("phoneError"),c=document.getElementById("carError"),P=document.getElementById("mainServiceError"),q=document.getElementById("discountSection"),O=document.getElementById("discountPercent");if(!d||!T||!v||!u||!_)return;let i=1,k="",f=[],a={name:"",phone:"",carModel:"",mainService:"",additionalServices:[],discount:0,timestamp:""};const A=/^(\+7|7|8)?[\s\-]?\(?[0-9]{3}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}$/,D={"antigravity-film":5e4,"disk-painting":3e4,cleaning:15e3,ceramic:25e3,polish:1e4};function j(){if(f.length===0)return 0;const o=Math.min([0,2,4,8,12,16,20][f.length]||20,20);let E=0;f.forEach(F=>{E+=D[F]||0});const V=Math.floor(E/1e4)*.5,J=Math.min(o+V,20);return Math.round(J)}function I(){const t=j();t>0?(O.textContent=`-${t}%`,q.style.display="flex"):q.style.display="none",a.discount=t}function R(){return s.value.trim().length<2?(L.textContent="Имя должно содержать минимум 2 символа",L.classList.add("active"),!1):(L.classList.remove("active"),!0)}function x(){const t=r.value.trim();return A.test(t)?(l.classList.remove("active"),!0):(l.textContent="Введите корректный номер телефона",l.classList.add("active"),!1)}function b(){return m.value.trim().length<3?(c.textContent="Укажите марку и модель автомобиля",c.classList.add("active"),!1):(c.classList.remove("active"),!0)}function U(){return k?(P.classList.remove("active"),!0):(P.textContent="Выберите основную услугу",P.classList.add("active"),!1)}function e(t){B.forEach(E=>{E.classList.remove("popup__step--active")});const o=document.querySelector(`[data-step="${t}"]`);o&&o.classList.add("popup__step--active"),i=t,n(t),p(t),w()}function n(t){const o={1:"Мы перезвоним и ответим на все вопросы в течение 15 минут",2:"Выберите основную услугу",3:"Выберите дополнительные услуги",4:"Ваш запрос в работе. Перезвоним в течение 15 минут."};o[t]&&(N.textContent=o[t])}function p(t){const o=document.querySelector(".popup");t===4?o.classList.add("popup--compact"):o.classList.remove("popup--compact")}function w(){v.style.display=i<3?"flex":"none",u.style.display=i===3?"flex":"none",_.style.display=i===4?"flex":"none",(i===1||i===2)&&(v.textContent="Продолжить")}function h(){d.classList.add("active"),document.body.style.overflow="hidden",i=1,e(1),$(),setTimeout(()=>{s.focus()},300)}function M(){d.classList.remove("active"),document.body.style.overflow="",i=1}function $(){s.value="",r.value="",m.value="",k="",f=[],g.forEach(t=>t.classList.remove("popup__service-btn--active")),C.forEach(t=>t.classList.remove("popup__additional-btn--selected")),I()}v.addEventListener("click",function(){if(i===1){const t=R(),o=x(),E=b();t&&o&&E&&(a.name=s.value.trim(),a.phone=r.value.trim(),a.carModel=m.value.trim(),a.timestamp=new Date().toISOString(),e(2))}else i===2&&U()&&(a.mainService=k,e(3),I())}),g.forEach(t=>{t.addEventListener("click",function(){g.forEach(o=>o.classList.remove("popup__service-btn--active")),this.classList.add("popup__service-btn--active"),k=this.dataset.service,P.classList.remove("active")})}),C.forEach(t=>{t.addEventListener("click",function(){const o=this.dataset.service;f.includes(o)?(f=f.filter(E=>E!==o),this.classList.remove("popup__additional-btn--selected")):(f.push(o),this.classList.add("popup__additional-btn--selected")),I()})}),u.addEventListener("click",function(){a.additionalServices=[...f],a.discount=j(),e(4),G(a)}),_.addEventListener("click",function(){M()}),T.addEventListener("click",M),d.addEventListener("click",function(t){t.target===d&&M()}),document.addEventListener("keydown",function(t){t.key==="Escape"&&d.classList.contains("active")&&M()}),s.addEventListener("input",R),r.addEventListener("input",x),m.addEventListener("input",b),r.addEventListener("input",function(t){let o=t.target.value.replace(/\D/g,"");o.length>11&&(o=o.slice(0,11)),o.length>=6?o=o.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/,"+$1 ($2) $3-$4-$5"):o.length>=3?o=o.replace(/(\d{1})(\d{3})/,"+$1 ($2"):o.length>=1&&(o="+"+o),t.target.value=o,x()}),document.querySelectorAll(".btn-primary, .about-btn, .footer__button, .burger-menu__btn").forEach(t=>{t.addEventListener("click",function(o){o.preventDefault(),h()})});function G(t){const o="https://app.sbercrm.com/react-gateway/api/webhook/9c5fc3c2-1761-43a8-980a-21c18f85476e",E={carbon:"karbon",antichrome:"antikhrom"},V={ceramic:"keramika","antigravity-film":"oklejka_antigravijnoj_plenkoj","disk-painting":"okras_kolesnykh_diskov",polish:"polirovka",cleaning:"khimchistka"},J=E[t.mainService]||t.mainService,F=t.additionalServices.map(S=>V[S]||S),K={name:`Заявка от ${t.name}`,userName$c:t.name,userPhone$c:t.phone,car_model$c:t.carModel,main_service$c:J,additional_services$c:F.join(","),discount$c:t.discount};fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(K)}).then(S=>{S.ok||S.text().then(W=>{})}).catch(S=>{}),fetch("/api/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:t.name,phone:t.phone,carModel:t.carModel,mainService:t.mainService,additionalServices:t.additionalServices,discount:t.discount,source:"WEBSITE"})}).then(S=>{S.ok&&typeof ym=="function"&&ym(106816930,"reachGoal","form_success")}).catch(S=>{})}d&&(window.openPopup=function(){d.classList.add("active"),document.body.style.overflow="hidden",i=1,e(1),$(),setTimeout(()=>{s==null||s.focus()},300)})});document.addEventListener("DOMContentLoaded",function(){const d=document.querySelectorAll(".main-option"),T=document.querySelectorAll(".additional-option"),v=document.querySelector(".services__cta"),u=document.getElementById("discountPopupOverlay"),_=document.getElementById("discountPopupClose"),s=document.getElementById("discountSubmitBtn"),r=document.getElementById("discountUserName"),m=document.getElementById("discountUserPhone"),B=document.getElementById("discountCarModel");if(!u||!_||!s||!r||!m||!B)return;const N=document.getElementById("discountTitle"),g=document.getElementById("discountNameError"),C=document.getElementById("discountPhoneError"),L=document.getElementById("discountCarError");let l="",c=[],P={};const q=/^(\+7|7|8)?[\s\-]?\(?[0-9]{3}\)?[\s\-]?[0-9]{3}[\s\-]?[0-9]{2}[\s\-]?[0-9]{2}$/,O={carbon:8e4,antichrome:6e4,"antigravity-film":5e4,"disk-painting":3e4,cleaning:15e3,ceramic:25e3,polish:1e4};function i(){if(c.length===0&&!l)return 0;let e=0;if(l&&O[l]&&(e+=O[l]),c.forEach($=>{O[$]&&(e+=O[$])}),e===0)return 0;const n=(l?1:0)+c.length,w=Math.min([0,2,4,8,12,16,20][n]||20,20),h=Math.floor(e/1e4)*.5,M=Math.min(w+h,25);return Math.round(M)}function k(){if(v){const e=l||c.length>0;v.disabled=!e}}d.forEach(e=>{e.addEventListener("click",function(){d.forEach(n=>n.classList.remove("main-option--active")),this.classList.add("main-option--active"),l=this.dataset.service,k()})}),T.forEach(e=>{e.addEventListener("click",function(){const n=this.dataset.option;c.includes(n)?(c=c.filter(p=>p!==n),this.classList.remove("additional-option--selected")):(c.push(n),this.classList.add("additional-option--selected")),k()})});function f(){const e=i();e>0&&(N.textContent=`Ваша персональная скидка — ${e}%`,u.classList.add("active"),document.body.style.overflow="hidden",setTimeout(()=>{r.focus()},300))}function a(){u.classList.remove("active"),document.body.style.overflow=""}function A(){const e=document.getElementById("successPopupOverlay"),n=document.getElementById("successPopupClose"),p=document.getElementById("discountSuccessBtn");if(e){let h=function(){e.classList.remove("active"),document.body.style.overflow="",D()};var w=h;e.classList.add("active"),document.body.style.overflow="hidden",n&&(n.removeEventListener("click",h),n.addEventListener("click",h)),p&&(p.removeEventListener("click",h),p.addEventListener("click",h)),e.removeEventListener("click",x),e.addEventListener("click",x),document.removeEventListener("keydown",b),document.addEventListener("keydown",b)}}function D(){l="",d.forEach(e=>e.classList.remove("main-option--active")),c=[],T.forEach(e=>e.classList.remove("additional-option--selected")),k(),r&&m&&B&&(r.value="",m.value="",B.value="",g&&g.classList.remove("active"),C&&C.classList.remove("active"),L&&L.classList.remove("active"))}function j(){return r.value.trim().length<2?(g.textContent="Имя должно содержать минимум 2 символа",g.classList.add("active"),!1):(g.classList.remove("active"),!0)}function I(){const e=m.value.trim();return q.test(e)?(C.classList.remove("active"),!0):(C.textContent="Введите корректный номер телефона",C.classList.add("active"),!1)}function R(){return B.value.trim().length<3?(L.textContent="Укажите марку и модель автомобиля",L.classList.add("active"),!1):(L.classList.remove("active"),!0)}m.addEventListener("input",function(e){let n=e.target.value.replace(/\D/g,"");n.length>11&&(n=n.slice(0,11)),n.length>=6?n=n.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/,"+$1 ($2) $3-$4-$5"):n.length>=3?n=n.replace(/(\d{1})(\d{3})/,"+$1 ($2"):n.length>=1&&(n="+"+n),e.target.value=n,I()}),r.addEventListener("input",j),m.addEventListener("input",I),B.addEventListener("input",R),v&&v.addEventListener("click",function(e){e.preventDefault(),v.disabled||f()}),s&&s.addEventListener("click",function(){const e=j(),n=I(),p=R();!e||!n||!p||(s.classList.add("loading"),s.textContent="Отправляем...",s.disabled=!0,P={name:r.value.trim(),phone:m.value.trim(),carModel:B.value.trim(),mainService:l,additionalServices:[...c],discount:i(),timestamp:new Date().toISOString()},U(P),setTimeout(()=>{a(),A(),s.classList.remove("loading"),s.textContent="Отправить заявку",s.disabled=!1},1500))}),_&&_.addEventListener("click",a),u&&u.addEventListener("click",function(e){e.target===u&&a()}),document.addEventListener("keydown",function(e){e.key==="Escape"&&u&&u.classList.contains("active")&&a()});function x(e){const n=document.getElementById("successPopupOverlay");e.target===n&&(n.classList.remove("active"),document.body.style.overflow="",D())}function b(e){const n=document.getElementById("successPopupOverlay");e.key==="Escape"&&n&&n.classList.contains("active")&&(n.classList.remove("active"),document.body.style.overflow="",D(),document.removeEventListener("keydown",b))}function U(e){const n="https://app.sbercrm.com/react-gateway/api/webhook/9c5fc3c2-1761-43a8-980a-21c18f85476e",p={carbon:"karbon",antichrome:"antikhrom"},w={ceramic:"keramika","antigravity-film":"oklejka_antigravijnoj_plenkoj",film:"oklejka_antigravijnoj_plenkoj","disk-painting":"okras_kolesnykh_diskov",disks:"okras_kolesnykh_diskov",polish:"polirovka",cleaning:"khimchistka"},h=p[e.mainService]||e.mainService,M=e.additionalServices.map(y=>w[y]||y),$={name:`Заявка от ${e.name}`,userName$c:e.name,userPhone$c:e.phone,car_model$c:e.carModel,main_service$c:h,additional_services$c:M.join(","),discount$c:e.discount};fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify($)}).then(y=>{y.ok||y.text().then(G=>{})}).catch(y=>{}).finally(()=>{s.classList.remove("loading"),s.textContent="Отправить заявку",s.disabled=!1}),fetch("/api/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e.name,phone:e.phone,carModel:e.carModel,mainService:e.mainService,additionalServices:e.additionalServices,discount:e.discount,source:"WEBSITE"})}).then(y=>{y.ok&&typeof ym=="function"&&ym(106816930,"reachGoal","form_success")}).catch(y=>{})}k()});
