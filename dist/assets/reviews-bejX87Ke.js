import"./metrika-BY1HYfmI.js";import"./discount-popup-C8REf4fq.js";class m{constructor(){this.reviews=[],this.filteredReviews=[],this.displayedCount=6,this.currentSort="default",this.currentServiceFilter="all",this.currentStep_review=1,this.selectedServices=[],this.reviewData={carModel:"",reviewText:"",photos:[]},this.init()}init(){this.loadReviews(),this.bindEvents()}updateActiveFilterButtons(){document.querySelectorAll("#sortMenu .filter-dropdown__option").forEach(r=>{r.classList.remove("filter-dropdown__option--active"),r.dataset.value===this.currentSort&&r.classList.add("filter-dropdown__option--active")});const i=document.querySelector(`#sortMenu .filter-dropdown__option[data-value="${this.currentSort}"]`);i&&(document.querySelector(".filter-dropdown__text").textContent=i.textContent),document.querySelectorAll("#servicesMenu .filter-dropdown__option").forEach(r=>{r.classList.remove("filter-dropdown__option--active"),r.dataset.value===this.currentServiceFilter&&r.classList.add("filter-dropdown__option--active")})}bindEvents(){this.bindReviewPopupEvents();const e=document.getElementById("sortToggle"),i=document.getElementById("sortMenu");e&&i&&(e.addEventListener("click",o=>{o.stopPropagation(),i.classList.toggle("active")}),i.addEventListener("click",o=>{if(o.target.classList.contains("filter-dropdown__option")){this.currentSort=o.target.dataset.value;const n=e.querySelector(".filter-dropdown__text");n&&(n.textContent=o.target.textContent),i.classList.remove("active"),this.applyFilters()}}));const t=document.getElementById("servicesToggle"),r=document.getElementById("servicesMenu");t&&r&&(t.addEventListener("click",o=>{o.stopPropagation(),r.classList.toggle("active")}),r.addEventListener("click",o=>{const n=o.target.closest(".filter-dropdown__option");n&&(this.currentServiceFilter=n.dataset.value,r.classList.remove("active"),this.applyFilters())}));const s=document.getElementById("showMoreBtn");s&&s.addEventListener("click",()=>{this.displayedCount+=6,this.renderReviews()}),document.addEventListener("click",o=>{o.target.closest(".filter-dropdown")||document.querySelectorAll(".filter-dropdown__menu.active").forEach(n=>{n.classList.remove("active")})})}applyFilters(){let e=[...this.reviews];switch(this.currentServiceFilter!=="all"&&(e=e.filter(i=>Array.isArray(i.servicesSelected)&&i.servicesSelected.includes(this.currentServiceFilter))),this.currentSort==="positive"?e=e.filter(i=>i.rating>=4):this.currentSort==="negative"&&(e=e.filter(i=>i.rating<=2)),this.currentSort){case"date":e.sort((i,t)=>new Date(t.rawDate)-new Date(i.rawDate));break}this.filteredReviews=e,this.displayedCount=6,this.renderReviews(),this.updateActiveFilterButtons()}renderReviews(){const e=document.getElementById("reviewsGrid");if(!e)return;const i=this.filteredReviews.slice(0,this.displayedCount);if(e.innerHTML="",i.length===0){e.innerHTML='<div class="no-reviews">Отзывы не найдены</div>';return}i.forEach(r=>{const s=document.createElement("div");s.innerHTML=this.createReviewCard(r),e.appendChild(s.firstElementChild)});const t=document.getElementById("showMoreBtn");t&&(t.style.display=this.displayedCount<this.filteredReviews.length?"flex":"none")}async loadReviews(){try{const e=await fetch("/api/reviews");if(!e.ok)throw new Error("Failed to fetch reviews");const i=await e.json();this.reviews=i.map(t=>({id:t.id,rating:t.rating,servicesSelected:t.servicesSelected||[],carModel:`${t.carBrand} ${t.carModel}`,text:t.text,date:new Date(t.datePublished||t.dateCreated).toLocaleDateString("ru-RU"),hasImage:t.images&&t.images.length>0,image:t.images&&t.images.length>0?t.images[0]:null,tags:t.tags||[]})),this.filteredReviews=[...this.reviews],this.applyFilters()}catch{}}createReviewCard(e){const i=Array(5).fill(0).map((s,o)=>`<img src="${o<e.rating?"img/black-star.svg":"img/star-zero.svg"}" alt="Star">`).join(""),t=e.hasImage?`<div class="review-card-reviews__image">
                <img src="${e.image}" alt="Фото результата">
            </div>`:"",r=e.tags.map(s=>`<span class="review-card-reviews__tag">${s}</span>`).join("");return`
            <div class="review-card-container" data-id="${e.id}">
                <div class="review-card-reviews">
                    <div class="review-card-reviews__header">
                        <div class="review-card-reviews__stars">
                            ${i}
                        </div>
                        <div class="review-card-reviews__date">${e.date}</div>
                    </div>
                    <p class="review-card-reviews__text">${e.text}</p>
                    ${t}
                </div>
                <div class="review-card-below-tags">
                    ${r}
                </div>
            </div>
        `}async submitReview(){var l;if(!this.validateStep(3))return;const e=document.getElementById("reviewCarModel"),i=document.getElementById("reviewText"),t=document.getElementById("reviewRating"),r=e.value.trim(),s=r.indexOf(" ");let o=r,n="";s>0&&(o=r.substring(0,s),n=r.substring(s+1));const c={rating:parseInt(t.value)||5,carBrand:o,carModel:n||"Unknown",service:((l=this.selectedServices)==null?void 0:l[0])||"website",text:i.value,servicesSelected:this.selectedServices,status:"PENDING",tags:[]};try{if(this.uploadedFiles&&this.uploadedFiles.length>0){const d=this.uploadedFiles.map(u=>{const v=new FormData;return v.append("file",u),fetch("/api/uploads/images",{method:"POST",body:v}).then(h=>h.json())}),p=await Promise.all(d);c.images=p.map(u=>u.url)}else c.images=[];if(!(await fetch("/api/reviews",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)})).ok)throw new Error("Failed to submit review");typeof ym=="function"&&ym(106816930,"reachGoal","form_success"),this.showNotification("Отзыв успешно отправлен на модерацию!"),this.showNotification("Отзыв успешно отправлен на модерацию!"),this.currentStep_review=4,this.updatePopupStep()}catch{alert("Ошибка при отправке отзыва")}}handleReviewPhotoUpload(e){const i=Array.from(e.target.files);this.uploadedFiles||(this.uploadedFiles=[]),i.forEach(t=>{if(t.type.startsWith("image/")){this.uploadedFiles.push(t);const r=new FileReader;r.onload=s=>{this.addReviewPhotoPreview(s.target.result,t.name)},r.readAsDataURL(t)}})}addReviewPhotoPreview(e,i){const t=document.getElementById("reviewPhotoPreview");if(!t)return;const r=document.createElement("div");r.className="photo-upload__preview-item",r.innerHTML=`
            <img src="${e}" alt="${i}">
            <button type="button" class="photo-upload__preview-remove">
                <img src="img/close.svg" alt="Remove">
            </button>
        `;const s=r.querySelector(".photo-upload__preview-remove");s.onclick=o=>{o.stopPropagation();const n=Array.from(t.children).indexOf(r);this.uploadedFiles&&n>=0&&this.uploadedFiles.splice(n,1),r.remove()},t.appendChild(r)}getServiceName(e){return{antichrome:"Антихром",carbon:"Карбон",soundproofing:"Шумоизоляция",wheels:"Колесные диски",cleaning:"Химчистка","antigravity-film":"Антигравийная пленка","disk-painting":"Покраска дисков",ceramic:"Керамика",polish:"Полировка",other:"Другое"}[e]||e}handlePhotoUpload(e){const i=Array.from(e.target.files),t=document.getElementById("photoPreview");t&&i.forEach(r=>{if(r.type.startsWith("image/")){const s=new FileReader;s.onload=o=>{const n=document.createElement("div");n.className="photo-upload__preview-item",n.innerHTML=`
                        <img src="${o.target.result}" alt="Preview">
                        <div class="photo-upload__preview-remove">
                            <img src="img/close.svg" alt="Remove">
                        </div>
                    `,n.querySelector(".photo-upload__preview-remove").addEventListener("click",()=>{n.remove(),this.removeUploadedPhoto(o.target.result)}),t.appendChild(n),this.addUploadedPhoto(o.target.result)},s.readAsDataURL(r)}})}addUploadedPhoto(e){this.uploadedPhotos||(this.uploadedPhotos=[]),this.uploadedPhotos.push(e)}removeUploadedPhoto(e){this.uploadedPhotos&&(this.uploadedPhotos=this.uploadedPhotos.filter(i=>i!==e))}clearPhotoPreview(){const e=document.getElementById("photoPreview");e&&(e.innerHTML=""),this.uploadedPhotos=[]}showNotification(e,i="success"){const t=document.createElement("div");t.className=`notification notification--${i}`,t.textContent=e,Object.assign(t.style,{position:"fixed",top:"20px",right:"20px",padding:"15px 20px",backgroundColor:i==="success"?"#1458E4":"#ff4444",color:"#ffffff",borderRadius:"10px",zIndex:"10001",transform:"translateX(100%)",transition:"transform 0.3s ease",maxWidth:"300px",fontSize:"14px",fontFamily:"Inter, sans-serif"}),document.body.appendChild(t),setTimeout(()=>{t.style.transform="translateX(0)"},100),setTimeout(()=>{t.style.transform="translateX(100%)",setTimeout(()=>{t.remove()},300)},3e3)}bindReviewPopupEvents(){const e=document.querySelector(".reviews-page__leave-btn");e==null||e.addEventListener("click",()=>{this.openReviewPopup()});const i=document.getElementById("reviewPopupClose");i==null||i.addEventListener("click",()=>{this.closeReviewPopup()});const t=document.getElementById("reviewPopupOverlay");t==null||t.addEventListener("click",a=>{a.target===t&&this.closeReviewPopup()});const r=document.getElementById("reviewContinueBtn");r==null||r.addEventListener("click",()=>{this.nextStep()});const s=document.getElementById("reviewSubmitBtn");s==null||s.addEventListener("click",()=>{this.submitReview()});const o=document.getElementById("reviewSuccessBtn");o==null||o.addEventListener("click",()=>{this.closeReviewPopup()}),document.querySelectorAll(".popup__additional-btn").forEach(a=>{a.addEventListener("click",d=>{this.selectService(d.target.dataset.service,d.target)})});const c=document.getElementById("reviewPhotoInput");c==null||c.addEventListener("change",a=>{this.handleReviewPhotoUpload(a)});const l=document.getElementById("reviewRatingStars");if(l){const a=l.querySelectorAll("img"),d=document.getElementById("reviewRating");a.forEach((p,u)=>{p.addEventListener("click",()=>{const v=u+1;d.value=v,this.updateStars(v),this.hidePopupError("reviewRatingError")}),p.addEventListener("mouseenter",()=>{this.updateStars(u+1,!0)})}),l.addEventListener("mouseleave",()=>{const p=parseInt(d.value)||0;this.updateStars(p)})}}updateStars(e,i=!1){document.querySelectorAll("#reviewRatingStars img").forEach((r,s)=>{s<e?r.src="img/black-star.svg":r.src="img/star-zero.svg"})}openReviewPopup(){const e=document.getElementById("reviewPopupOverlay");e&&(this.currentStep_review=1,this.selectedServices=[],this.resetReviewPopup(),e.classList.add("active"),document.body.style.overflow="hidden")}closeReviewPopup(){const e=document.getElementById("reviewPopupOverlay");e&&(e.classList.remove("active"),document.body.style.overflow="",this.resetReviewPopup())}nextStep(){this.validateStep(this.currentStep_review)&&(this.currentStep_review++,this.updatePopupStep())}updatePopupStep(){document.querySelectorAll(".popup__step-review").forEach((s,o)=>{s.classList.toggle("popup__step-review--active",o+1===this.currentStep_review)});const e=document.getElementById("reviewPopupTitle");if(e)switch(this.currentStep_review){case 1:e.textContent="Оставь отзыв — сделаем сервис лучше вместе";break;case 2:e.textContent="Оцените результат нашей работы";break;case 3:e.textContent="Укажите, какие работы мы выполнили для вас";break;case 4:e.textContent="Готово! Отзыв скоро появится после модерации.";break}const i=document.getElementById("reviewContinueBtn"),t=document.getElementById("reviewSubmitBtn"),r=document.getElementById("reviewSuccessBtn");i&&(i.style.display=this.currentStep_review<3?"flex":"none"),t&&(t.style.display=this.currentStep_review===3?"flex":"none"),r&&(r.style.display=this.currentStep_review===4?"flex":"none"),this.updatePopupHeight()}updatePopupHeight(){const e=document.getElementById("reviewPopupOverlay");if(!e)return;const i=e.querySelector(".popup");if(!i)return;let t;const r=window.innerWidth<=768;switch(this.currentStep_review){case 1:t=r?"500px":"600px";break;case 2:t=r?"300px":"400px";break;case 3:t=r?"500px":"700px";break;case 4:t="300px";break;default:t=r?"500px":"700px"}i.style.height=t,this.centerPopup(i)}centerPopup(){const e=document.querySelector(".popup");e&&(e.style.transform="translate(-50%, -50%) scale(1)",e.style.top="50%",e.style.left="50%",e.style.position="fixed")}validateStep(e){switch(e){case 1:const i=document.getElementById("reviewCarModel").value.trim(),t=document.getElementById("reviewText").value.trim();return i?t?(this.reviewData.carModel=i,this.reviewData.reviewText=t,!0):(this.showPopupError("reviewTextError","Напишите ваш отзыв"),!1):(this.showPopupError("reviewCarError","Укажите марку и модель авто"),!1);case 2:return parseInt(document.getElementById("reviewRating").value)===0?(this.showPopupError("reviewRatingError","Пожалуйста, выберите рейтинг"),!1):!0;case 3:return this.selectedServices.length===0?(this.showPopupError("reviewServiceError","Выберите хотя бы одну услугу"),!1):!0;default:return!0}}selectService(e,i){this.selectedServices.includes(e)?(this.selectedServices=this.selectedServices.filter(t=>t!==e),i.classList.remove("popup__additional-btn--selected")):(this.selectedServices.push(e),i.classList.add("popup__additional-btn--selected")),this.hidePopupError("reviewServiceError")}showPopupError(e,i){const t=document.getElementById(e);t&&(t.textContent=i,t.classList.add("active"))}hidePopupError(e){const i=document.getElementById(e);i&&i.classList.remove("active")}resetReviewPopup(){this.currentStep_review=1,this.selectedServices=[],this.uploadedFiles=[],this.reviewData={carModel:"",reviewText:"",photos:[]};const e=document.getElementById("reviewCarModel"),i=document.getElementById("reviewText"),t=document.getElementById("reviewRating"),r=document.getElementById("reviewPhotoPreview");e&&(e.value=""),i&&(i.value=""),t&&(t.value="0"),r&&(r.innerHTML=""),this.updateStars(0),document.querySelectorAll(".popup__additional-btn").forEach(s=>{s.classList.remove("popup__additional-btn--selected")}),document.querySelectorAll(".popup__error").forEach(s=>{s.classList.remove("active")}),this.updatePopupStep()}handleWindowResize(){const e=document.getElementById("reviewPopupOverlay");e&&e.classList.contains("active")&&this.updatePopupHeight()}}document.addEventListener("DOMContentLoaded",()=>{new m});
