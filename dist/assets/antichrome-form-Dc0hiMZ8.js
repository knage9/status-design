document.addEventListener("DOMContentLoaded",function(){const l=document.querySelector(".antichrome-form__form");if(!l)return;const u=l.querySelector(".antichrome-form__submit"),r=t=>{for(const e of t){const n=document.getElementById(e);if(n)return n}return null},i=r(["antichromeFormName","carbonFormName"]),s=r(["antichromeFormPhone","carbonFormPhone"]),c=r(["antichromeFormCar","carbonFormCar"]),S=r(["antichromeFormNameError","carbonFormNameError"]),C=r(["antichromeFormPhoneError","carbonFormPhoneError"]),P=r(["antichromeFormCarError","carbonFormCarError"]),F=document.querySelectorAll(".additional-option"),d=r(["antichromeDiscountSection","carbonDiscountSection"]),D=r(["antichromeDiscountPercent","carbonDiscountPercent"]),a=document.getElementById("successPopupOverlay"),B=document.getElementById("successPopupClose"),$=document.getElementById("discountSuccessBtn"),I=l.querySelector('input[name="mainService"]');let v=I?I.value:"antichrome",o=[],m=0;const M={"antigravity-film":5e4,"disk-painting":3e4,cleaning:15e3,ceramic:25e3,polish:1e4};function p(){return i?i.value.trim().length<2?(g(S,"Имя должно содержать минимум 2 символа"),!1):(b(S),!0):!0}function E(){if(!s)return!0;const t=s.value.trim();return/^[\+]?[0-9\s\-\(\)]{10,}$/.test(t)?(b(C),!0):(g(C,"Введите корректный номер телефона"),!1)}function y(){return c?c.value.trim().length<3?(g(P,"Укажите марку и модель автомобиля"),!1):(b(P),!0):!0}function g(t,e){t&&(t.textContent=e,t.classList.add("active"))}function b(t){t&&(t.textContent="",t.classList.remove("active"))}function f(){if(!u)return;const t=!i||i.value.trim().length>=2,e=!s||/^[\+]?[0-9\s\-\(\)]{10,}$/.test(s.value.trim()),n=!c||c.value.trim().length>=3,h=!!v;u.disabled=!(t&&e&&n&&h)}function N(){if(!d||!D)return;if(o.length===0){m=0,d.style.display="none";return}const e=Math.min([0,2,4,8,12,16,20][o.length]||20,20);let n=0;o.forEach(L=>{n+=M[L]||0});const h=Math.floor(n/1e4)*.5;m=Math.min(e+h,20),D.textContent=`-${Math.round(m)}%`,d.style.display="block"}i&&(i.addEventListener("input",()=>{p(),f()}),i.addEventListener("blur",p)),s&&(s.addEventListener("input",function(t){let e=t.target.value.replace(/\D/g,"");e.length>11&&(e=e.slice(0,11)),e.length>=6?e=e.replace(/(\d{1})(\d{3})(\d{3})(\d{2})(\d{2})/,"+$1 ($2) $3-$4-$5"):e.length>=3?e=e.replace(/(\d{1})(\d{3})/,"+$1 ($2"):e.length>=1&&(e="+"+e),t.target.value=e,E(),f()}),s.addEventListener("blur",E)),c&&(c.addEventListener("input",()=>{y(),f()}),c.addEventListener("blur",y)),F.forEach(t=>{t.addEventListener("click",function(){const e=this.dataset.option;o.includes(e)?(o=o.filter(n=>n!==e),this.classList.remove("additional-option--selected")):(o.push(e),this.classList.add("additional-option--selected")),N()})}),l.addEventListener("submit",async function(t){t.preventDefault();const e=p(),n=E(),h=y();if(e&&n&&h&&v){u.textContent="Отправляем...",u.disabled=!0;const L={name:i.value,phone:s.value,carModel:c.value,mainService:v,additionalServices:o,discount:Math.round(m),source:"WEBSITE"};try{if((await fetch("/api/requests",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(L)})).ok)a?a.classList.add("active"):alert("Спасибо за заявку! Мы свяжемся с вами в течение 15 минут."),typeof ym=="function"&&ym(106816930,"reachGoal","form_success"),l.reset(),F.forEach(x=>x.classList.remove("additional-option--selected")),o=[],m=0,d&&(d.style.display="none");else throw new Error("Server error")}catch{alert("Произошла ошибка при отправке. Пожалуйста, попробуйте позже или позвоните нам.")}finally{u.textContent="Отправить заявку",f()}}}),B&&B.addEventListener("click",()=>{a.classList.remove("active")}),$&&$.addEventListener("click",()=>{a.classList.remove("active")}),a&&a.addEventListener("click",t=>{t.target===a&&a.classList.remove("active")}),f()});
